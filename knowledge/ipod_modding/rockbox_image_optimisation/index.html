 <!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D00k &nbsp;â€¢  Rockbox Image Optimisation </title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" type="image/png" href="/img/assets/favicon.png">
    <link rel="me" href="https://post.lurk.org/@dook">
    <meta property="og:image" content="/img/knowledge/linux/imagemagick.svg" />
    <meta property="og:description" 
  content="Information on the image formats of Rockbox Theming and how to optimise them best." />
 </head>

  
 <body>
  <header class="knowledge colours">
    
<div>
<nav>
<ul class="name">
	  	<li>
  		<a class="name" href="/">ðŸ—¦DookðŸ—§</a>
  	</li>
</ul>
  <ul role="list">
  
   
    <li>
      <a class="" href="/gallery/">
        Gallery
      </a>
    </li>
  
   
    <li>
      <a class="" href="/projects/">
        Projects
      </a>
    </li>
  
   
    <li>
      <a class="active" href="/knowledge/">
        Knowledge
      </a>
    </li>
  
   
    <li>
      <a class="" href="/journal/">
        Journal
      </a>
    </li>
  
   
    <li>
      <a class="" href="/about/">
        About
      </a>
    </li>
   
</ul>
</nav> 
</div>

  </header>
   <main>
    <h1>Rockbox Image Optimisation</h1>
          
        <ul class="tags">
          
          <li><a class="round-button" href="/tags/ipod/">ipod</a></li>
          
          <li><a class="round-button" href="/tags/rockbox/">rockbox</a></li>
          
          <li><a class="round-button" href="/tags/imagemagick/">imagemagick</a></li>
          
        </ul>
      
     <hr>
    <p>When producing Rockbox themes with large feature-sets, images can quickly become a bottleneck both in terms of filesize as well as graphical quality. There are many ways to address these issues, however in this guide I will cover the best practices I have discovered and incorporated into my toolbox.</p>
<h2 id="the-bitmap-image-format">The Bitmap image format</h2>
<p>Rockbox&rsquo;s primary image format is the Bitmap. Versions 3 and 4 of the bitmap spec are recognised, while any lower specs are not. The wiki <a href="https://www.rockbox.org/wiki/CustomWPS#LCD_Screen_Sizes_47_BMP_Compatibility" target="_blank" rel="noopener">states</a> that 1-bit, 24-bit and 32-bit Bitmaps are supported, however from experience 16-bit is also acceptable. I bring up 16-bits as all images used by Rockbox are converted into 16-bit colour regardless. This brings up the first issues. When this conversion is done, no dithering is applied, leaving an often unsavoury and harsh result. By pre-processing our images, we can not only achieve better looking results but also much smaller filesizes.</p>
<figure>
 	<div>
     <img src="/img/knowledge/ipod_modding/dither_comparison.png" loading="lazy" alt="a comparison of an image with no dither and with a dither">
     <figcaption>No dither versus ordered dither.</figcaption>
     <hr>
 	</div>
 </figure>
<h2 id="optimising-with-gimp">Optimising with GIMP</h2>
<p>The best free method of optimising images I have found is with <a href="https://www.gimp.org/" target="_blank" rel="noopener">GIMP</a>. It has a wide range of dithering algorithms that produce nice results, as well as a predictable colour indexing that consistently provides small file sizes. The only downside to GIMP is that the steps cannot be automated, and thus must be repeated each time an image needs to be converted.</p>
<h3 id="colour-dithering">Colour dithering</h3>
<p>To produce better looking images in Rockbox, we must pre-process our images by limiting the colour palette and use dithering to blend these together. We find this tool by going to <strong>Colors &gt; Dither&hellip;</strong></p>
<p>Inside, it may seem a little complicated at first, but understanding what we need should help. Rockbox uses a 16-bit colorspace, we can get a good visualisation of this by using Rockbox&rsquo;s built-in colour tools in the theme settings. Both the Red and Blue colours are limited to just 32 options, while Green has 64. This is known as RGB565. If we take these maximum limits, and input them into the Red, Green and Blue levels of our Dither tool in GIMP, we can dither our image in this colorspace. The rest of the options are not of importance, except for <strong>Dithering method</strong>. This changes the dithering style, and is entirely up to you and what you think looks best.</p>
<figure>
 	<div>
     <img src="/img/knowledge/ipod_modding/Dither_Tool.jpg" loading="lazy" alt="The gimp dither tool">
     <figcaption>GIMP Dither tool.</figcaption>
     <hr>
 	</div>
 </figure>
<h3 id="indexed-colors">Indexed Colors</h3>
<p>The simplest step to achieving optimised filesizes is the Indexed Color tool. This is found by going to <strong>Image &gt; Mode &gt; Indexed</strong>. Once in we, have several options available. Under <strong>Colormap</strong> we can choose what limitations we wish to put on the image&rsquo;s palette. For 1-bit images, the black and white palette is perfect and you shouldn&rsquo;t need any other steps.</p>
<p>For colour images, we use <strong>Generate optimum palette</strong> which lets us set a number. This number, however, is only a maximum. If we select <strong>Remove unused and duplicate colors from colormap</strong>, GIMP will automatically trim the Colormap down to only the colours used by the image. In the second part of the dialog, we can choose what dithering to use. This can be purely preference based, however for small, low-colour images like icons I recommend not using dithering at all and setting it to <strong>None</strong>.</p>
<figure>
 	<div>
     <img src="/img/knowledge/ipod_modding/Index_Color.jpg" loading="lazy" alt="The gimp indexed colour tool">
     <figcaption>GIMP Indexed Colour Tool.</figcaption>
     <hr>
 	</div>
 </figure>
<h3 id="exporting-from-gimp">Exporting from GIMP</h3>
<p>Exporting as a Bitmap in GIMP provides several options. The <strong>Advanced Options</strong> dialog will be unavailable if you have used indexed colour, but if you haven&rsquo;t, the options dictate the format of your bitmap image. Generally you want <strong>R5 G6 B5</strong> under the <strong>16 bits</strong> list, however if you are using true transparency (not the magenta-based masking) <strong>A8 R8 G8 B8</strong> under <strong>32 bits</strong> is used.</p>
<p>The other option available is the <strong>Compatibility Options</strong>. I uncheck <strong>Do not write color space information</strong>, this saves some bytes in filesize and is also unnecessary since Rockbox will convert our image&rsquo;s colour space regardless</p>
<figure>
 	<div>
     <img src="/img/knowledge/ipod_modding/Export_Options.jpg" loading="lazy" alt="Gimp exporting options">
     <figcaption>GIMP&#39;s exporting options for bitmaps.</figcaption>
     <hr>
 	</div>
 </figure>
<h2 id="automating-the-process">Automating the Process</h2>
<p>While GIMP is useful, the amount of manual inputs that need to be done can be time consuming and tedious in projects with a large number of assets. To counter this, I attempted to produce a script using <a href="https://imagemagick.org/" target="_blank" rel="noopener">ImageMagick</a> that could automate the process. The project was somewhat a success, however ImageMagick proved to be the wrong tool for the job (which I&rsquo;ll talk a bit more about at the end). I&rsquo;ve split it into several different scripts based on the job and results desired.</p>
<h3 id="background-images">Background Images</h3>
<p>These scripts take your backdrop images, 320x240 pixels, and converts them into the RGB565 bitmaps. If you wish to understand to script options chosen, <em>-type palette</em> turns on indexed colour, <em>-compress none</em> turns off compression, which isn&rsquo;t supported by Rockbox, and the final format and define section outputs the image as a version 3 bitmap.</p>
<p>There&rsquo;s two versions here, one uses ordered dithering and the other Floyd-Steinberg dithering. Floyd Steinberg does require an image to use as a colormap. I&rsquo;ve used <a href="https://commons.wikimedia.org/wiki/File:RGB_16bits_palette.png" target="_blank" rel="noopener">this</a> png of 16-bit colourspace.</p>
<p>These two scripts will both produce colour-accurate bitmaps that are always 77.9kBs large. They can also be used on other images, however I will cover why you mightn&rsquo;t want to.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl"># Floyd Steinberg Dither
</span></span><span class="line"><span class="cl">mogrify -dither FloydSteinberg -remap RGB_16bits_palette.png -compress None -type palette -format bmp -define bmp:format=bmp3 INPUT.png
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Ordered/Positioned Dither
</span></span><span class="line"><span class="cl">mogrify -ordered-dither o8x8,32,64,32 -compress None -type palette -format bmp -define bmp:format=bmp3 INPUT.png
</span></span></code></pre></div><h3 id="icon-images">Icon Images</h3>
<p>Generally, small icons do not need to be dithered with a pattern. For this case, I made a script that converts images with a basic, direct dither.</p>
<p>One thing to note here is the optional <strong>-kmeans 16</strong> option. This limits the colormap of the image, and can give you a decent filesize reduction. However it&rsquo;s worth testing different values for their results, hence this script is non-destructive and keeps the original input (unlike mogrify, which will overwrite the original image if it is the same filetype). You can still get a respectable filesize without using kmeans, it&rsquo;s also worth mentioning that sometimes it doesn&rsquo;t work (and I don&rsquo;t know why, but the feature is buggy apparently).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">convert INPUT.png -kmeans 16 -ordered-dither 1x1,32,64,32 -compress None -type palette BMP3:OUTPUT.bmp 
</span></span></code></pre></div><h3 id="mix-and-match">Mix and Match</h3>
<p>You might find yourself in situations not covered by these scripts, for example small icon images with a lot of colour you want dithered in a fancy style. In this case, mix and match the options! The optional <strong>-kmeans</strong> can work with the background image scripts, and visa versa.</p>
<h3 id="1-bit-bitmaps">1-bit bitmaps</h3>
<p>A quick and simple script to convert images into 1-bit bitmaps with the smallest size. The <strong>-type bilevel</strong> converts them to indexed 1-bit bitmaps with just 2 colours (black and white)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">mogrify -depth 1 -type bilevel -compress None -type palette -format bmp -define bmp:format=bmp3 INPUT.png
</span></span></code></pre></div><h2 id="where-imagemagick-failed">Where ImageMagick failed</h2>
<p>I ran into more than a few issues with Imagemagick making these scripts. The biggest was certain sized images having bigger filesizes than the exact same processes in GIMP, just 600-1000 bytes. Which may not be a problem for some but in a project pushing the extremes of Rockbox&rsquo;s file upload limits, these small gains can help a lot. I tracked this issue down to the colormaps of the files containing a large number of junk entries, the colormap would be set to 255 and any image with less would have the remainding space filled with these junk entries. Another issue with Imagemagick is the lack of dithering algorithms, just 2 compared to GIMP having around 7-8.</p>
<p>My solution for this will be to create my own image conversion tool specifically for making these Rockbox-targetting bitmaps. The backbone will be makew0rld&rsquo;s <a href="https://github.com/makew0rld/dither" target="_blank" rel="noopener">dither library</a>. Having this level of fine control over the conversion should hopefully allow for the creation of incredible accurate images with the smallest file sizes possible (even smaller than GIMP!) I&rsquo;ll probably get to making this the next time I encounter the tedium of image conversion.</p>

    <div class="back">
     <a class="prev" href="/knowledge/ipod_modding/">âŒ© Back to iPod Modding</a>
   </div>
  </main>
 </body>

 <footer>
  <hr>
       <a href="https://webring.xxiivv.com/#d00k" target="_blank" alt="webring">
        <svg fill="var(--text)" stroke="var(--text)" stroke-linecap="square" stroke-width="28" xmlns="http://www.w3.org/2000/svg" viewBox="0 -15 300 300" height="40" width="40">
                            &gt;
                            <path d="M201.962 210a60 60 0 10-103.924-60l-50 86.603" fill="var(--background)" stroke="var(--text)"></path>
                            <path d="M98.038 210a60 60 0 10103.924-60l-50-86.603" fill="var(--background)" stroke="var(--text)"></path>
                            <path d="M150 120a60 60 0 100 120h100" fill="var(--background)" stroke="var(--text)"></path>
                            &lt; <circle xmlns="http://www.w3.org/2000/svg" fill="var(--background)" r="60" stroke="var(--text)" cx="150" cy="180" stroke-width="28"></circle>
                        </svg>
      </a>
      <a href="/index.xml" target="_blank" alt="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 210 210" height="34" width="34" stroke-width="10" stroke="var(--text)" fill="var(--text)"><path d="M30,45 A15,15 0 0,1 15,30 A15,15 0 0,1 30,15 A150,150 0 0,1 180,165 A15,15 0 0,1 165,180 A15,15 0 0,1 150,165 A120,120 0 0,0 30,45 M30,105 A15,15 0 0,1 15,90 A15,15 0 0,1 30,75 A90,90 0 0,1 120,165 A15,15 0 0,1 105,180 A15,15 0 0,1 90,165 A60,60 0 0,0 30,105 M30,135 A30,30 0 0,1 60,165 A30,15 0 0,1 30,180 A15,15 0 0,1 15,165 A15,30 0 0,1 30,135 "></path></svg>
      </a>
      <a href="https://github.com/D0-0K" target="_blank" alt="github">
        <svg viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg" height="34" width="34"><path style="fill: var(--text);" d="M63.994.152C28.66.152 0 28.806 0 64.158c0 28.272 18.336 52.26 43.768 60.726 3.2.586 4.37-1.392 4.37-3.084 0-1.52-.06-5.544-.092-10.888-17.8 3.87-21.56-8.576-21.56-8.576-2.906-7.394-7.102-9.364-7.102-9.364-5.812-3.972.44-3.888.44-3.888 6.424.452 9.8 6.592 9.8 6.592 5.712 9.784 14.984 6.96 18.63 5.32.58-4.14 2.234-6.96 4.06-8.56-14.21-1.612-29.15-7.104-29.15-31.63 0-6.984 2.494-12.7 6.588-17.172-.66-1.62-2.856-8.12.628-16.932 0 0 5.374-1.72 17.6 6.56 5.104-1.42 10.58-2.128 16.02-2.152 5.44.024 10.914.734 16.024 2.154 12.22-8.28 17.58-6.56 17.58-6.56 3.496 8.81 1.3 15.316.64 16.936 4.104 4.476 6.58 10.19 6.58 17.174 0 24.586-14.966 30-29.22 31.58 2.296 1.98 4.34 5.88 4.34 11.854 0 8.556-.076 15.46-.076 17.56 0 1.706 1.154 3.7 4.4 3.074C109.68 116.396 128 92.42 128 64.156 128 28.808 99.344.152 63.994.152z"/></svg>
      </a>   
      <div style="float:right;">
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
      </div> 
   </footer>